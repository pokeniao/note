---
日期: 2024-03-21
tags:
  - 开发经验
aliases:
  - 支付方式
---

**我的沙箱**
	*商家信息*
		商户账号：qusewk1600@sandbox.com
		登录密码：111111
		商户PID：2088721031309916
	*买家信息*
		买家账号：ysdbfq5002@sandbox.com
		登录密码：111111
		支付密码：111111
		用户UID：2088722031287749
		用户名称：ysdbfq5002
		证件类型：IDENTITY_CARD
		证件账号：056702191001149895

**准备工作**
创建接口或沙箱模式[支付宝开放平台 (alipay.com)](https://open.alipay.com/develop/sandbox/app)
*导入配置* 
并且引入到项目[[Pasted image 20240321014537.png]]
```java fold:alipay-sandbox.properties
# 支付宝支付相关参数  
# 应用ID ,APPID  
alipay.app.id=9021000135602597
  
# 绑定的商家账号（PID  
alipay.seller-id=2088721031309916
  
# 支付宝网关  
alipay.gateway-url= 
  
#商户私钥 RSA2私钥  
alipay.merchant-private-key=  
  
# 支付宝公钥  
alipay.alipay-public-key=
  
# 接口内容加密方式 对此密钥  
alipay.content-key=CrElJstE0Tmqem8x9jXN7g==  
  
#支付成功返回地址
alipay.return-url=

#支付包异步调用本地接口url  
alipay.notify-url=
```
*导入依赖* [依赖](https://opendocs.alipay.com/common/02kkv2?pathHash=358ff034)
```java fold:Alipay SDK
    <dependency>
        <groupId>com.alipay.sdk</groupId>
        <artifactId>alipay-sdk-java</artifactId>
        <version>4.31.72.ALL</version>
    </dependency>

```
封装签名配置类（设置公共请求参数），返回 new AlipayConfig()
```java fold:PayConfig
@Configuration
//获取当前类路径下的properties
@PropertySource("classpath:alipay-sandbox.properties")
public class AlipayClientConfig {
	//获取properties
    @Resource
    private Environment config;

    @Bean
    public AlipayClient alipayClient() throws AlipayApiException {
        AlipayConfig alipayConfig = new AlipayConfig();
        //设置网关地址
        alipayConfig.setServerUrl(config.getProperty("alipay.gateway-url"));
        //设置应用ID
        alipayConfig.setAppId(config.getProperty("alipay.app.id"));
        //设置应用私钥
        alipayConfig.setPrivateKey(config.getProperty("alipay.merchant-private-key"));
        //设置请求格式，固定值json
        alipayConfig.setFormat(AlipayConstants.FORMAT_JSON);
        //设置字符集
        alipayConfig.setCharset(AlipayConstants.CHARSET_UTF8);
        //设置支付宝公钥
        alipayConfig.setAlipayPublicKey(config.getProperty("alipay.alipay-public-key"));
        //设置签名类型
        alipayConfig.setSignType(AlipayConstants.SIGN_TYPE_RSA2);
        //构造client
        AlipayClient alipayClient = new DefaultAlipayClient(alipayConfig);
        return alipayClient;
    }
}
```
# 支付
[[Pasted image 20240321020231.png|支付流程图]]
通过aplipayConfig可以进行支付
1. 调用支付宝,返回页面支付页面
```java
AlipayTradePagePayResponse response = alipayClient.pageExecute(request)
if (response.isSuccess()) {
log.info("调用成功");  
return response.getBody();  
} else {  log.info("调用失败!!");  }
```
2. 请求参数request的设置
```java
//创建一个request
AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
//支付成功会跳转到我们设置的一个页面
request.setReturnUrl(config.getProperty("alipay.return-url"));


//面向对象封装业务参数  
AlipayTradePagePayModel model =new AlipayTradePagePayModel();
model.setOutTradeNo("20150320010101001");  
model.setTotalAmount("100");  
model.setSubject("qusewk1600@sandbox.com");
model.setProductCode("FAST_INSTANT_TRADE_PAY");
request.setBizModel(model);
```
**业务请求参数** 更多参数查看[统一收单下单并支付页面接口 - 支付宝文档中心 (alipay.com)](https://opendocs.alipay.com/open/59da99d0_alipay.trade.page.pay?scene=22&pathHash=e26b497f)

| 参数               | 描述                                                      |
| ---------------- | ------------------------------------------------------- |
| **out_trade_no** | 商户网站唯一订单号                                               |
| **total_amount** | 订单总金额，单位为元，精确到小数点后两位                                    |
| **subject**      | 订单标题                                                    |
| **product_code** | 销售产品码，与支付宝签约的产品码名称。注：目前电脑支付场景下仅支持FAST_INSTANT_TRADE_PAY |



我们可以主动发起查询订单的请求

# 支付回调（异步回调）
[异步通知说明 - 支付宝文档中心 (alipay.com)](https://opendocs.alipay.com/open/270/105902?pathHash=d5cd617e)
*支付宝成功会调用我们的一个接口*
1. 本地测试设置要[[内网穿透]]
2. 设置request
```js
//支付宝回调地址  
request.setNotifyUrl(config.getProperty("alipay.notify-url"));
```
3. controller
```java
@Resource  
private Environment config;
@PostMapping("/buyNotify")  
public String buyNotify(@RequestBody Map<String,String> params) throws Exception {  
	String success="failure";  
	if(alipayService.buyNotify(params))  { success="success";}  
	//在进行异步通知交互时，如果支付宝收到的应答不是 success ，支付宝会认为通知失败，定期重新发起通知  
	return success;  
}
```